<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Confirm Mapping | Column Mapper</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen p-4 md:p-12">
    <div class="max-w-3xl mx-auto bg-white rounded-xl shadow-xl overflow-hidden">
        <div class="bg-blue-600 p-6">
            <h1 class="text-white text-2xl font-bold">Step 2: Map Your Columns</h1>
            <p class="text-blue-100 text-sm mt-1">Assign your CSV columns to the required system fields.</p>
        </div>

        <div class="p-8">
            <div id="errorBox" class="mb-6 p-4 bg-red-50 border-l-4 border-red-500 text-red-700 hidden"></div>

            <div class="border rounded-lg overflow-hidden mb-8">
                <table class="w-full text-left">
                    <thead class="bg-gray-50 border-b">
                        <tr>
                            <th class="px-6 py-3 text-xs font-bold text-gray-500 uppercase">System Field</th>
                            <th class="px-6 py-3 text-xs font-bold text-gray-500 uppercase">CSV Column Source</th>
                        </tr>
                    </thead>
                    <tbody id="mappingTableBody" class="divide-y divide-gray-100">
                        </tbody>
                </table>
            </div>

            <div id="saveMappingSection" class="mb-8 p-6 bg-green-50 rounded-lg border border-green-200 hidden transform transition-all duration-300">
                <h3 class="text-green-800 font-bold mb-2">Validation Successful!</h3>
                <label class="block text-sm font-medium text-green-700 mb-2">Give this mapping configuration a name:</label>
                <input type="text" id="mappingNameInput" placeholder="e.g., Q1_Sales_Report" 
                       class="w-full p-3 border border-green-300 rounded-md focus:ring-2 focus:ring-green-500 outline-none">
            </div>

            <div class="flex flex-col md:flex-row justify-between items-center gap-4 border-t pt-6">
                <button onclick="window.location.href='/ui/index.html'" class="text-gray-400 hover:text-gray-600 font-medium transition">
                    ‚Üê Start Over
                </button>
                
                <div class="flex gap-3">
                    <button id="validateBtn" onclick="handleValidation()" 
                            class="px-6 py-3 bg-blue-600 text-white rounded-lg font-bold hover:bg-blue-700 transition disabled:bg-gray-300 disabled:cursor-not-allowed">
                        Validate Mapping
                    </button>
                    <button id="submitBtn" onclick="handleFinalSubmit()" disabled
                            class="px-6 py-3 bg-green-600 text-white rounded-lg font-bold opacity-30 cursor-not-allowed transition hover:bg-green-700">
                        Confirm & Save
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let uploadData = {};

        // 1. Initialization
        function init() {
            const rawData = sessionStorage.getItem('uploadResult');
            if (!rawData) {
                window.location.href = '/ui/index.html';
                return;
            }
            uploadData = JSON.parse(rawData);
            renderTable();
        }

        // 2. Render Table: System Fields on Left, Dropdowns on Right
        function renderTable() {
            const tbody = document.getElementById('mappingTableBody');
            const { source_columns, target_fields, suggested_mapping } = uploadData;

            target_fields.forEach(field => {
                const row = document.createElement('tr');
                const suggestedSource = suggested_mapping[field] || "";

                row.innerHTML = `
                    <td class="px-6 py-4 text-sm font-bold text-gray-700">${field}</td>
                    <td class="px-6 py-4">
                        <select class="mapping-select w-full p-2 border border-gray-300 rounded focus:border-blue-500 outline-none" data-target="${field}">
                            <option value="">-- Ignore / Empty --</option>
                            ${source_columns.map(col => `
                                <option value="${col}" ${suggestedSource === col ? 'selected' : ''}>${col}</option>
                            `).join('')}
                        </select>
                    </td>
                `;
                tbody.appendChild(row);
            });

            // Add change listeners to every select to reset the state
            document.querySelectorAll('.mapping-select').forEach(select => {
                select.addEventListener('change', resetState);
            });
        }

        // 3. State Management
        function resetState() {
            document.getElementById('validateBtn').disabled = false;
            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            submitBtn.classList.add('opacity-30', 'cursor-not-allowed');
            document.getElementById('saveMappingSection').classList.add('hidden');
            document.getElementById('errorBox').classList.add('hidden');
        }

        // 4. Validation Call
        async function handleValidation() {
            const errorBox = document.getElementById('errorBox');
            const mapping = getMappingFromUI();

            try {
                const response = await fetch('/validate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ filename: uploadData.saved_filename, mapping })
                });

                const result = await response.json();

                if (response.ok) {
                    // Success state
                    document.getElementById('validateBtn').disabled = true;
                    const submitBtn = document.getElementById('submitBtn');
                    submitBtn.disabled = false;
                    submitBtn.classList.remove('opacity-30', 'cursor-not-allowed');
                    document.getElementById('saveMappingSection').classList.remove('hidden');
                    errorBox.classList.add('hidden');
                } else {
                    throw new Error(result.detail || "Validation failed");
                }
            } catch (err) {
                errorBox.innerText = err.message;
                errorBox.classList.remove('hidden');
            }
        }

        // 5. Final Submit & Save
        async function handleFinalSubmit() {
            const mappingName = document.getElementById('mappingNameInput').value.trim();
            const errorBox = document.getElementById('errorBox');
            
            if (!mappingName) {
                alert("Please provide a name for this mapping configuration.");
                return;
            }

            try {
                const response = await fetch('/process', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        mapping: getMappingFromUI(),
                        mapping_name: mappingName 
                    })
                });

                const result = await response.json();

                if (response.ok) {
                    alert("Mapping saved and data processed successfully!");
                    sessionStorage.removeItem('uploadResult');
                    window.location.href = '/ui/index.html';
                } else {
                    throw new Error(result.detail || "Submission failed");
                }
            } catch (err) {
                errorBox.innerText = err.message;
                errorBox.classList.remove('hidden');
            }
        }

        function getMappingFromUI() {
            const mapping = {};
            document.querySelectorAll('.mapping-select').forEach(s => {
                if (s.value) mapping[s.getAttribute('data-target')] = s.value;
            });
            return mapping;
        }

        // Ensure init runs even if event already fired
        if (document.readyState === "loading") {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
    </script>
</body>
</html>